# 仮想通貨市場の板情報を利用したHFT(高頻度取引)<br>マーケットメイク戦略　〜片側指値追従ver.

<br>

## 概要

当コードは、仮想通貨市場(BTC)における板情報(買い気配、売り気配など)を取得し、秒単位の高頻度で取引するものです。

板情報は、秒未満で変化しうるので、これを用いることで高密度のリアルタイム情報を利用することが可能になります。

ここでのマーケットメイク戦略とは、**売り気配(ask)と買い気配(bid)に指値を置くことで、約定した際の売買差額(spread)を利益とする戦略**のことです。

片側指値追従とは、買いまたは売りの、どちらかの指値をブレイクした方向に、順張りで追従していくようなスタンスをとります。

以下、マーケットメイクについての説明（Avellaneda, Stoikov(2008)のマーケットメイク理論式）を軸にして、この戦略の全体像を記述していきます。

<br>

## マーケットメイク戦略

ここで用いられるマーケットメイクの意味合いは、前述の通り、板の上下に買い指値と売り指値を供給し、対価としてスプレッドを得るという戦略です。

これを最適化問題のような形で定義するならば、以下の命題に帰着できます。

<br>

**ある一定期間(T)の経過後に、自身の資産価値(V)を最大化するような、指値の幅(<img src="https://latex.codecogs.com/svg.image?\delta&space;_{ask+bid}"/>)を求める問題**

<br>

それぞれの用語を定義付けします。

まず、一定期間のTとは、数秒スパンでのわずかな時間になります。本格的に突き詰めるなら、ミリ秒〜になりますが、ここでは例えば5秒とします。

次に、資産価値(V)ですが、これは現金と在庫(ポジション)に分けられます。両方の指値が約定すれば現金が増える一方で、片方の指値が取り残されれば、在庫として抱えることになります。

最後に指値の幅ですが、買い指値と売り指値を置く場所は、両方の最良気配値の中央値(<img src="https://latex.codecogs.com/svg.image?&space;S_{t}">)を基準にして、それぞれ
<img src="https://latex.codecogs.com/svg.image?\delta&space;_{ask}"/>、
<img src="https://latex.codecogs.com/svg.image?\delta&space;_{bid}"/>
離れた位置に置くことになり、これが幅になります。

さて、今一度振り返って考えると、「5秒後の収益を最大化する指値幅の算出問題」という見方が可能です。

以下、数式導出のために、いくつかの前提条件を確認していきます。

<br>

#### (a) 在庫リスク

在庫を持つということは、その間は市場の価格変動リスクに晒され続けることになります。これが、在庫リスクになります。

そのため、単に資産を最大化させるのではなく、在庫リスクを念頭に入れた効用関数(U)を最大化することになります。

AvellanedaとStoikovによる効用関数では、以下の形としています。

<br>

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{U=E[-exp[-\gamma(C_{t}&plus;q_{t}S_{t})]]}">

（ <img src="https://latex.codecogs.com/svg.image?\gamma&space;"> : リスク回避度、
<img src="https://latex.codecogs.com/svg.image?C_{t}"> : t時点のキャッシュ、
<img src="https://latex.codecogs.com/svg.image?q_{t}"> : t時点の在庫、
<img src="https://latex.codecogs.com/svg.image?S_{t}"> : t時点の中央値 ）

<br>

#### (b) 板の厚み

各価格帯に置かれた指値の累積和を取ることで、板の厚みを求めることができます。

供給量に左右される短期戦略においては、板の厚み・深さという概念は重要になります。

実際の板では、中央値に近い価格帯ほど供給量が多くなるため、厚みの関数はexp関数で近似します。

<br>

#### (c) 注文の強さ

注文の強さとは、単位時間あたりで中央値周辺の価格帯での約定量を示したものです。

これは、(b)板の厚みと、その時点で流入する成行注文の量で決定されます。

注文の強さは、以下の関数で定義されます。

<br>

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{\lambda(\delta)=Ae_{}^{-\alpha\delta}}">

<br><br>

以上の前提条件を基に、マーケットメイク戦略の基本式を立てることができます。

<br>

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{\delta&space;_{ask&plus;bid}=\gamma\sigma&space;_{}^{2}(T-t)&plus;\frac{2}{\lambda}ln(1&plus;\frac{\gamma}{\alpha})}"> &emsp; -(1)

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{S_{offset}=\gamma\sigma&space;_{}^{2}(T-t)q_{t}}"> &emsp; &emsp; &emsp; &emsp; &emsp; &emsp; &ensp; -(2)
 
<br>

#### (d) 指値幅

上式(1)は、指値幅を求める数式です。

前半の項はリスクの指標、後半の項ではリターンの指標を表しています。

前半のリスク式ですが、これは (リスク回避度) * (残存ボラティリティ) によって計算されています。

残存ボラティリティとは、時点tから満了時点Tまでの残り時間における分散の大きさのことです。

実際には、回避度あるいは残存ボラが大きければ大きいほど、指値の幅が広がり、これによって約定量を限定し、リスク回避的な挙動となります。

<br>

次にリターン式ですが、これは実質的には <img src="https://latex.codecogs.com/svg.image?\alpha&space;">(注文の強さ)によって決まります。

この式におけるリターンとは、(約定のしやすさ) * (指値幅) となっており、注文の強さに依存させる式となっています。

すなわち、注文の強さ(板の厚み形状+成行注文量)が大きいほど、約定しやすくなるため、指値の幅を広めにとることで単体期待値を高めます。

逆に小さければ、約定確率は減少するので、指値の幅を狭めることで対応させます。

<br>

#### (e) オフセット値

下式(2)は、中央値からのオフセット値を求める数式です。

オフセットとは、補正のような意味合いで、指値幅におけるズレを修正するための値です。

計算式としては、 -(リスク回避度) * (残存ボラティリティ) * (在庫量) となっています。

つまり、ある時点で在庫 <img src="https://latex.codecogs.com/svg.image?q_{t}">を持っていた時、それを解消する方向へ優先的にオフセット量が調整されます。

このオフセットの調整を挟むことで、指値位置が在庫のサイドと逆側に移動することになります。

リスク回避度やボラティリティ、また在庫量が大きければ大きいほど、オフセット値は大きくなり、これによって在庫の解消が促進されます。


