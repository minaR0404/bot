# 仮想通貨市場の板情報を利用したHFT(高頻度取引)<br>マーケットメイク戦略　〜片側指値追従ver.

**当コードは1年以上前のものであり、またその有効性を保証するものではありません。**

<br>

## 概要

当コードは、仮想通貨市場(BTC)における板情報(買い気配、売り気配など)を取得し、秒単位の高頻度で取引するものです。

板情報は、秒未満で変化しうるので、これを用いることで高密度のリアルタイム情報を利用することが可能になります。

ここでのマーケットメイク戦略とは、**売り気配(ask)と買い気配(bid)に指値を置くことで、約定した際の売買差額(spread)を利益とする戦略**のことです。

片側指値追従とは、買いまたは売りの、どちらかの基準値をブレイクした方向に追従していくようなスタンスをとります。

以下、マーケットメイクについての説明（Avellaneda, Stoikov(2008)のマーケットメイク理論式）を軸にして、この戦略の全体像を記述していきます。

<br>

## マーケットメイク戦略

ここで用いられるマーケットメイクの意味合いは、前述の通り、板の上下に買い指値と売り指値を供給し、対価としてスプレッドを得るという戦略です。

これを最適化問題のような形で定義するならば、以下の命題に帰着できます。

<br>

**ある一定期間(T)の経過後に、自身の資産価値(V)を最大化するような、指値の幅(<img src="https://latex.codecogs.com/svg.image?\delta&space;_{ask+bid}"/>)を求める問題**

<br>

それぞれの用語を定義付けします。

まず、一定期間のTとは、数秒スパンでのわずかな時間になります。ここでは一例として、5秒とします。

次に、資産価値(V)ですが、これは現金と在庫(ポジション)に分けられます。両方の指値が約定すれば現金が増える一方で、片方の指値が取り残されれば、在庫として抱えることになります。

最後に指値の幅ですが、買い指値と売り指値を置く場所は、両方の最良気配値の中央値(<img src="https://latex.codecogs.com/svg.image?&space;S_{t}">)を基準にして、それぞれ
<img src="https://latex.codecogs.com/svg.image?\delta&space;_{ask}"/>、
<img src="https://latex.codecogs.com/svg.image?\delta&space;_{bid}"/>
離れた位置に置くことになり、これが幅になります。

さて、今一度振り返って考えると、「5秒後の収益を最大化する指値幅の算出問題」という見方が可能です。

以下、数式導出のために、いくつかの前提条件を確認していきます。

<br>

#### (a) 在庫リスク

在庫を持つということは、その間は市場の価格変動リスクに晒され続けることになります。これが、在庫リスクになります。

そのため、単に資産を最大化させるのではなく、在庫リスクを念頭に入れた効用関数(U)を最大化することになります。

AvellanedaとStoikovによる効用関数では、以下の形としています。

<br>

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{U=E[-exp[-\gamma(C_{t}&plus;q_{t}S_{t})]]}">

（ <img src="https://latex.codecogs.com/svg.image?\gamma&space;"> : リスク回避度、
<img src="https://latex.codecogs.com/svg.image?C_{t}"> : t時点のキャッシュ、
<img src="https://latex.codecogs.com/svg.image?q_{t}"> : t時点の在庫、
<img src="https://latex.codecogs.com/svg.image?S_{t}"> : t時点の中央値 ）

<br>

#### (b) 板の厚み

各価格帯に置かれた指値の累積和を取ることで、板の厚みを求めることができます。

供給量に左右される短期戦略においては、板の厚み・深さという概念は重要になります。

実際の板では、中央値に近い価格帯ほど供給量が多くなるため、厚みの関数はexp関数で近似します。

<img width="699" alt="スクリーンショット 2023-10-05 2 23 43" src="https://github.com/minaR0404/bot/assets/49789283/fd0bedfb-979b-4a57-9029-e68c3a4c3df9">

<br>

#### (c) 注文の強さ

注文の強さとは、単位時間あたりで中央値周辺の価格帯での約定量を示したものです。

これは、(b)板の厚みと、その時点で流入する成行注文の量で決定されます。

注文の強さは、以下の関数で定義されます。

<br>

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{\lambda(\delta)=Ae_{}^{-\alpha\delta}}">

<br><br>

以上の前提条件を基に、マーケットメイク戦略の基本式を立てることができます。

<br>

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{\delta&space;_{ask&plus;bid}=\gamma\sigma&space;_{}^{2}(T-t)&plus;\frac{2}{\lambda}ln(1&plus;\frac{\gamma}{\alpha})}"> &emsp; -(1)

<img src="https://latex.codecogs.com/svg.image?\boldsymbol{S_{offset}=\gamma\sigma&space;_{}^{2}(T-t)q_{t}}"> &emsp; &emsp; &emsp; &emsp; &emsp; &emsp; &ensp; -(2)
 
<br>

#### (d) 指値幅

上式(1)は、指値幅を求める数式です。

前半の項はリスクの指標、後半の項ではリターンの指標を表しています。

前半のリスク式ですが、これは (リスク回避度) * (残存ボラティリティ) によって計算されています。

残存ボラティリティとは、時点tから満了時点Tまでの残り時間における分散の大きさのことです。

実際には、回避度あるいは残存ボラが大きければ大きいほど、指値の幅が広がり、これによって約定量を限定し、リスク回避的な挙動となります。

<br>

次にリターン式ですが、これは実質的には <img src="https://latex.codecogs.com/svg.image?\alpha&space;">(注文の強さ)によって決まります。

この式におけるリターンとは、(約定のしやすさ) * (指値幅) となっており、注文の強さに依存させる式となっています。

すなわち、注文の強さ(板の厚み形状+成行注文量)が大きいほど、約定しやすくなるため、指値の幅を広めにとることで単体期待値を高めます。

逆に小さければ、約定確率は減少するので、指値の幅を狭めることで対応させます。

<br>

#### (e) オフセット値

下式(2)は、中央値からのオフセット値を求める数式です。

オフセットとは、補正のような意味合いで、指値幅におけるズレを修正するための値です。

計算式としては、 -(リスク回避度) * (残存ボラティリティ) * (在庫量) となっています。

つまり、ある時点で在庫 <img src="https://latex.codecogs.com/svg.image?q_{t}">を持っていた時、それを解消する方向へ優先的にオフセット量が調整されます。

このオフセットの調整を挟むことで、指値位置が在庫のサイドと逆側に移動することになります。

リスク回避度やボラティリティ、また在庫量が大きければ大きいほど、オフセット値は大きくなり、これによって在庫の解消が促進されます。

<img width="668" alt="スクリーンショット 2023-10-05 2 11 09" src="https://github.com/minaR0404/bot/assets/49789283/9c303645-7767-441f-81a4-a62d1031d1d6">

<br><br>

## 片側指値追従戦略

純粋なマーケットメイク戦略の場合は、前述の通り適切な在庫管理手法などを用いてリスク軽減しつつ、資産期待値を最大化するような指値幅(スプレッド)を決定するものでした。

より具体的には、板において適度なスプレッドが開いた時点をエントリーポイントとして、計算された幅で指値を置くということをします。

ただし、実際の実運用では、適切だと判断した指値のエントリーに対し、片側の指値が置いていかれることが多発しました。

これを**逆選択リスク**と言います。先ほどの在庫リスクとほぼ同義です。

問題は、リターンの核となる実効スプレッド(≒指値幅)に対し、逆選択リスクが高くなりすぎてしまうことにあります。

つまり、1サイクルの取引で得られるスプレッド利益よりも、価格変動による在庫の価値減少の損失が上回ってしまう、という問題です。

<br>

この対策として、単にスプレッド(指値幅)をエントリー基準にするのではなく、**一方的な価格変動で片側にブレイクした時点をもって、幅を持って指値を置く**という戦略を取りました。

この背景には、数秒間の短期的な価格形成には、微弱なトレンドが存在しているのではないか、といった予想がありました。

<br>

以下は、大まかな流れになります。

1. 両側の最良気配値付近にビッドオファーの参考値を提示する
2. どちらか一方の参考値を歩み値(LTP, 約定履歴)がブレイクする
3. 適切な幅を計算し、両側に指値を置く
4. 指値が約定しない限り、オフセットを毎時点計算し、適宜指値の位置を調整する
5. 両側の指値が刺さったら、1サイクルを終了する

<br>

#### (f) 参考値

この参考値ですが、前述の通り一定期間(T)の最大化問題に合わせるために、5秒間の板情報を元に算出しています。

その時点での最良気配値(理論的には中央値)から、過去5秒間に発生した約定量を鑑みて、一定程度離れた位置を参考値としています。

この約定量という情報は、(c)注文の強さの要素を含んでいます。

<br>

#### (g) 歩み値

歩み値とは、実際に約定した際の価格です。

取得手段として、LTP(最終取引価格)、約定履歴を参照して得ることができます。

この値が、(f)参考値をブレイクアウトすることが、エントリーの基準となります。

<br>

#### (h) 在庫リスクへの対応

片側の指値のみ約定しているものの、もう一方の指値が約定しない場合は、毎時点で在庫リスクを抱えることになります。

そのため、短い間隔にて在庫リスクや価格情報を考慮に入れて、オフセット値を計算し、毎回指値の位置を調整させます。

リスクが高くなるほど、指値位置を縮めて、なるべく約定させるように設定します。

<br>

#### (i) サイクル終了

両側の指値が約定した時点で、在庫は解消され、1サイクルが終了することになります。

また、実際には、指値の全てが約定したり、完全に在庫が解消されるということはなく、未約定の状態が一定で残ることになります。

こうしたイレギュラーなケースにも対応する必要はあります。

<br>

ここまでが、実際のコードでの動きの概要になります。

しかし、実際のところ、これでも芳しい結果を得るには足りませんでした。

まず、短期的な価格形成における、明確なトレンド性を確認できなかった、という点があります。

中長期的なトレンドであればともかく、極短期におけるトレンド検出は、難度が極めて高いと言えます。

これは、この戦略のエントリーポイントの正当性を保証することができないことを意味します。

ただし、これはあくまで部分的なものであって、もしこの問題をクリアしたとしても、利益を確定的にするには不十分です。

<br>

より大まかな枠組みの中での本質的な問題点を挙げるとすれば、以下の2つになります。

<br>

#### (j) 逆選択リスク

少なくとも私の手法においては、逆選択リスクによる損失は、リターンに比して大きすぎると言えます。

ある時点でのスプレッドに対して、片側のみの指値約定により在庫を残した場合の、市場における価格変動の割合は相当大きく、数秒のディレイだけでもかなりの損失を受けます。

そのため、逆選択リスクの削減のためには、例えば指値の位置調整などをより高速化しなければなりません。

それはひいては、取引所への注文キャンセル、新規注文、板情報取得など、言語内操作に留まらず、こだわるならば通信インフラ等にも手を出す必要があります。

突き詰めて言えば、秒未満、ミリ秒単位、あるいは例えば株式の世界ではそれよりずっと速く、という極限の世界であり、一個人として参入するには障壁・要求スタックがあまりにも高いです。

<br>

#### (k) 執行コスト

HFTにおけるディレイの損失に関しては、執行コストも当てはまります。

同じ指値注文を出したとしても、取引所に届くのが遅ければ、その注文はその時点では執行されません。(厳密には執行が遅れる)

執行時の遅れは、そのまま市場価格の変動リスクに直接的に曝されることになります。

他のリスクで言えば、例えば板に対して指値を載せたとしても、その全てが約定するとは限りません。

例えば、10の指値注文に対して、7しか板に成行が入ってこなければ、残りの3は依然として残り続けます。

こうした全般的な執行コストは、理論の組み立て時には正確に予期することができませんでした。

<br>

## 最後に

理論的にはうまくいっているように見えても、実運用においては様々な遅延コストが発生します。

こうしたトゲのようなものは、高頻度においてはとても重いものであり、運用上の問題点を取り除こうと四苦八苦しましたが、行き着くところは、全ての速度を改善することであり、突き詰めれば終わりのないものでもあります。

かつて、未成熟だった頃の仮想通貨市場では、このような比較的シンプルな実装でも戦えたようですが、現時点では競合性も高まり、難易度は飛躍的に高くなっています。

とりわけ、高頻度においては、ごく一部の上澄みだけが勝てるような世界であり、半端な覚悟では生き残れないでしょう。

私の今回のコードは、いくらか作ったうちの供養品のようなものですが、こうした苛烈な環境でこそ成長できるところも多々あると思います。

こうした開発は苦しくもあり、また刺激的で面白くもあります。これからも精進していきたいと思っています。
